<div class="page-header">
	<h1>
		Posting
	</h1>
</div>

<div class="row">
	<div class="col-xs-12">
		<!-- Button for view -->
		<a class="btn btn-xs btn-info" th:href="@{/ledger/gen_ledger/index}">
			<i class="fa fa-home"></i> System Dashboard
		</a> 
		<a class="btn btn-xs btn-primary" th:href="@{/ledger/gen_ledger/create}">
			<i class="fa fa-plus-circle"></i> Add Account 
		</a>
	
 		<span   id="imgId" hidden="hidden" > 
 			<img th:src="@{/resources/assets/images/ajax-loader.gif}" id="loading_img" />  
 		</span>      
	</div>
</div>


<div>
	<form role="form" class="form-horizontal" id="form" style="margin-top:20px;">
		<div class="form-group container">
		     <label for="description" class="col-sm-3 control-label no-padding-right">Journal Description: </label>
		    <div class="col-sm-9">
				<input type="text" class="col-xs-10 col-sm-5" placeholder="description"
					th:value="*{journalHeader.description}"
					th:id="*{journalHeader.journalID}"
					th:name="description"
					 required="required" /> <span
					class="text-danger" th:if="${#fields.hasErrors('journalHeader.description')}"
					th:errors="*{journalHeader.description}"></span>
			</div>  
		</div>
		<button type="button" class="btn btn-primary add">New Entry</button> 
		<button type="submit" class="btn btn-success" id="save">Save Entries</button>
	 	<button type="submit" class="btn btn-default" id="post">Post Entries</button>
	
		 <div th:each="journalEntry : ${journalEntries}" class="form-group container journal">
		    <select class="accountType" required="required">
		        <option th:value="${journalEntry.accountType}">Select..</option>
		        <option value="CA">Customer</option>
		        <option value="GA">GL</option>
		    </select>
		    <div style="display:inline-table;"> 
		    	<input type="text" id="accountNoSearch" placeholder="account no" th:value="${journalEntry.accountNo}" required="required"/> <br />
		    	<select id="accountNo" size="" style="margin-top:0px;"  required="required"  hidden="hidden">
							<!-- <option th:each="generalLedger: ${generalLedgers}" 
							th:value = "${generalLedger.accountNo}" 
							th:text="|${generalLedger.accountNo}-${generalLedger.name}|">Posting Account</option> -->
				</select>
				<button class="custSearch" hidden="hidden">searcn</button> 
		   	</div>
		    <select id="postCode" required="required">
		        <option th:value="${journalEntry.postCode}">Select..</option>
		        <option value="DR">GL Debit</option>
		        <option value="CR">GL Credit</option>
		    </select>
		    <select id="branchID" th:value="${journalEntry.branchID}" required="required">
		    </select>
		    <input type="text" id="amount"  placeholder="amount" th:value="${journalEntry.amount}" required="required"/>
		    <input type="text" id="refNo"  placeholder="ref no" th:value="${journalEntry.refNo}" required="required"/>
		    <input type="text" id="desc"  placeholder="description" th:value="${journalEntry.description}" required="required"/>
		    <button type="button" class="btn btn-xs btn-default delete"><i class="fa fa-trash-o"></i></button>		    	
		</div>
		
	
	</form>
	
</div>

<script type="text/javascript">
/*<![CDATA[*/
     const saveBtn = document.getElementById('save');
     const postBtn = document.getElementById('post');
     //I'll actually get the button add an event listener to two separate functions which passes an argument to the
     // onSubmit function which attaches a description to the header, parsed to know whether to post or manageJou
     // at the back.
     saveBtn.addEventListener('click', () => onSubmit('save') );
     
     //if the post button is clicked, call the onSubmit method with the post para
     postBtn.addEventListener('click', () => onSubmit('post') );
     
     $(document).ready(function(){
    	 getBranches();
    	 

    	 $('.journal').each(function(){
    		 acc_type = $(this).find('.accountType option:selected')[0].value;
    	 	 accountSetup($(this), acc_type);
    	 });
    	 
     });
     
     $('.accountType').change(function(){
    	 var acc_type = $(this)[0].value;
    	 accountSetup($(this).parent(), acc_type);
     });
     
     $('.add').click(function(){
    	 div = document.createElement('div');
    	 console.log(window.branches);
    	 
    	 markup = '<select lass="accountType"  required="required"><option value="">Select..</option><option value="CA">Customer</option><option value="GA">GL</option></select><input type="text" id="accountNo" placeholder="account no"  required="required" /><select id="postCode"  required="required"><option value="">Select..</option><option value="DR">GL Debit</option><option value="CR">GL Credit</option></select><select id="branchID"  required="required">' + window.branches + '</select><input type="text" id="amount"  placeholder="amount"  required="required" /><input type="text" id="refNo"  placeholder="ref no"  required="required" /><input type="text" id="description"  placeholder="description"  required="required" /><button type="button" class="btn btn-xs btn-default delete"><i class="fa fa-trash-o"></i></button>';
    	 $(div).addClass("form-group container journal").html(markup);
    	 $('form').append(div);
     });
     
     
     $(document.body).on("click", ".delete", function(){
    	 $(this).parent().remove();
     });
     
     
     
     function onSubmit(action){
    	 
    	 var journalEntries = [];
    	 var header = {
    		"journalID": $('[name="description"]')[1].id,
    		"description": $('[name="description"]')[1].value,
    		"action": action
    	 }; 
    	 
    	 
    	 $('.journal').each(function(){
    		 var entry = {
    			"account_type": $(this).find('.accountType option:selected')[0].value,
    			"account_no": $(this).find('#accountNo option:selected')[0].value,
    			"post_code": $(this).find('#postCode option:selected')[0].value,
    			"branch_id": $(this).find('#branchID option:selected')[0].value,
    			"amount": $(this).find('#amount')[0].value,
    			"ref_no": $(this).find('#refNo')[0].value,
    			"desc": $(this).find('#desc')[0].value
    		 };
    		 
    		 journalEntries.push(entry);
    	 });
    	 
    	 journal = {
    		"journalHeader": header,
    		"journalEntries": journalEntries
    	 }
 		
		 $.ajax({
			type: "POST",
			contentType: "application/json",
			'processData': false,
			url : '/../'+ window.location.pathname.split('/')[1] + '/ledger/journal/edit',
			beforeSend : function() {
				$.gritter.add({
				title : "Progress...",
				text : "Saving Journal Entry...",
				time : 3000
				}); 
			},
			data: JSON.stringify(journal),
			dataType: "json",
			
			success: function(response, data){
			     alert("yuppie");
			     console.log(response, data);
			     window.location = '/../'+ window.location.pathname.split('/')[1] + '/ledger/journal/index';
			      
			},
			error: function(response){
				alert("nopppiee");
				window.location = '/../'+ window.location.pathname.split('/')[1] + '/ledger/journal/index';
			}
		});  
     }
     
     function getBranches() {
    		$.ajax({
    			type : "GET",
    			url : '/../'+ window.location.pathname.split('/')[1] + '/ledger/branches/',
    			success : function(value) {
    				branches = jQuery.parseJSON(value);
    				
    				$("select[id='branchID']").each(function() {
    					selectElement = this;
    					window.branches = "";
    					for (let branch of branches) {
    						let option = document.createElement('option');
    						option.value = branch["id"];
    						option.textContent = branch["name"];
    						selectElement.appendChild(option);
    						
    						window.branches += '<option value="' + branch["id"] + '">' + branch["name"] + '</option>';
     			    		
    					}
    				});
    				
    		    	selectOptions();
    			}
    		});
    	}
     
     function selectOptions() {
	     $("select").each(function(){
			 var selValue = $(this)[0].value;
			 var options = $(this)[0]["options"];
			 
			 $.each(options, function( index ) {
	 			if(this.value == selValue) {
			    	this.selected = true;
			    } 
			});
		 });
     }
     
     function accountSetup(journalElem, acc_type) {
    		 
   		 if(acc_type == 'GA') {
   			 accNoElem = journalElem.find('#accountNo');
   			 accNoElem.removeAttr("hidden");
   	    	 getAccounts(accNoElem, "GA");
   		 } else {
   			 searchElem = journalElem.find('#custSearch');
   			 searchElem.removeAttr("hidden");
   		 }
     }
     
     function getAccounts(elem, account_type) {
    		if(account_type != ''){
    			$.ajax({
        			type : "GET",
        			url : '/../'+ window.location.pathname.split('/')[1] + '/ledger/fetch/' + account_type,
        			
        			success : function(value) {
        				elem.html(value);
        			},
        			error : function() {
        				elem.html("");
        			}
        		});
    		}
    	}
/*]]>*/
</script>